---
- name: Setup iTerm2 (macOS)
  when: ansible_os_family == "Darwin"
  block:
    - name: Install iTerm2
      community.general.homebrew_cask:
        name: iterm2
        state: present

# --- Default shell to zsh (Linux) ---
- name: Ensure zsh is installed and set as default shell (Linux)
  when: ansible_os_family in ["Debian", "Alpine"]
  become: true
  block:
    - name: Ensure zsh is installed
      ansible.builtin.package:
        name: zsh
        state: present

    - name: Find zsh binary (no shell)
      ansible.builtin.command: which zsh
      register: ohMyZSH_zsh_path
      changed_when: false
      failed_when: ohMyZSH_zsh_path.rc != 0

    - name: Ensure {{ ohMyZSH_zsh_path.stdout }} is listed in /etc/shells
      ansible.builtin.lineinfile:
        path: /etc/shells
        line: "{{ ohMyZSH_zsh_path.stdout }}"
        state: present

    - name: Get current login shell from /etc/passwd
      ansible.builtin.command: getent passwd {{ ansible_user_id }}
      register: user_info
      changed_when: false

    - name: Change default shell to zsh if not already
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        shell: "{{ ohMyZSH_zsh_path.stdout | trim }}"
      when: user_info.stdout.split(':')[-1] | trim != (ohMyZSH_zsh_path.stdout | trim)

# --- Default shell to zsh (macOS) ---
- name: Ensure zsh is default shell (macOS)
  when: ansible_os_family == "Darwin"
  block:
    - name: Find zsh binary
      ansible.builtin.command: which zsh
      register: ohMyZSH_darwin_zsh
      changed_when: false
      failed_when: ohMyZSH_darwin_zsh.rc != 0

    - name: Ensure {{ ohMyZSH_darwin_zsh.stdout }} is listed in /etc/shells
      become: true
      ansible.builtin.lineinfile:
        path: /etc/shells
        line: "{{ ohMyZSH_darwin_zsh.stdout }}"
        state: present

    - name: Get current login shell (macOS)
      ansible.builtin.command: dscl . -read /Users/{{ ansible_user_id }} UserShell
      register: darwin_shell
      changed_when: false

    - name: Change default shell to zsh if not already (macOS)
      become: true
      ansible.builtin.command: chsh -s "{{ ohMyZSH_darwin_zsh.stdout | trim }}" "{{ ansible_user_id }}"
      when: darwin_shell.stdout is not search(ohMyZSH_darwin_zsh.stdout | trim)

# --- Oh My Zsh detection ---
- name: Check if Oh My Zsh is installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.oh-my-zsh"
  register: ohmyzsh_installed

# --- Oh My Zsh install (macOS) ---
- name: Setup Oh My Zsh (macOS)
  when:
    - ansible_os_family == "Darwin"
    - not ohmyzsh_installed.stat.exists
  block:
    - name: Download Oh My Zsh installer
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
        dest: /tmp/install_ohmyzsh.sh
        mode: "0755"

    - name: Run Oh My Zsh installer (unattended)
      ansible.builtin.command: /tmp/install_ohmyzsh.sh --unattended
      register: ohmyzsh_result
      changed_when: ohmyzsh_result.rc == 0
      failed_when: ohmyzsh_result.rc != 0

    - name: Ensure ZSH env var is set in .zshrc
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        regexp: '^export ZSH='
        line: 'export ZSH="$HOME/.oh-my-zsh"'
        state: present
        create: true
        mode: "0644"

# --- Theme / fonts ---
- name: Installing ZSH Theme (Powerlevel10k)
  when:
    - ansible_os_family in ["Darwin", "Alpine", "Debian"]
    - (ohmyzsh_installed.stat.exists or ansible_os_family == "Darwin")
  block:
    - name: Install Powerlevel10k (Darwin via Homebrew)
      when: ansible_os_family == "Darwin"
      community.general.homebrew:
        name: powerlevel10k
        state: present

    - name: Add Powerlevel10k theme source to .zshrc on Darwin
      when: ansible_os_family == "Darwin"
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        insertafter: '^source \$ZSH/oh-my-zsh\.sh$'
        line: 'source $(brew --prefix)/share/powerlevel10k/powerlevel10k.zsh-theme'
        state: present

    - name: Install Powerlevel10k (Debian/Alpine via git)
      when: ansible_os_family in ["Alpine", "Debian"]
      ansible.builtin.git:  # noqa latest[git]
        repo: https://github.com/romkatv/powerlevel10k.git
        dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes/powerlevel10k"
        depth: 1
        update: false
        version: HEAD

    - name: Ensure Powerlevel10k is the active theme
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        regexp: '^ZSH_THEME='
        line: 'ZSH_THEME="powerlevel10k/powerlevel10k"'
        state: present

    - name: Configure powerlevel10k in .zshrc (container override)
      when: ansible_env.container is defined
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        insertafter: '^ZSH_THEME='
        line: "[[ ! -f ~/.dotfiles/zshrc/themes/{{ item }} ]] || source ~/.dotfiles/zshrc/themes/{{ item }}"
        state: present
      loop:
        - dev.p10k.zsh

- name: Install Powerlevel10k fonts
  when:
    - ansible_env.HOME is defined
    - ansible_env.HOME != ''
  ansible.builtin.import_tasks: powerfont.yml
  tags: [fonts, powerlevel10k]

# --- History tuning ---
- name: Set zsh history configuration
  when:
    - ansible_os_family in ["Darwin", "Alpine", "Debian"]
    - ohmyzsh_installed.stat.exists
  ansible.builtin.import_tasks: hist.yml

# --- Plugins (common) ---
- name: Deploy ZSH plugins
  ansible.builtin.import_tasks: plugins.yml

# --- Dotfiles linking & zshrc includes ---
- name: Symlink dotfiles and source profiles (Oh My Zsh present)
  when:
    - ansible_os_family in ["Darwin", "Alpine"]
    - ohmyzsh_installed.stat.exists
  block:
    - name: Symlink git dotfiles
      ansible.builtin.file:
        src: "{{ ansible_env.HOME }}/.dotfiles/.profile/{{ item }}"
        dest: "{{ ansible_env.HOME }}/{{ item }}"
        state: link
        force: true
      loop:
        - .gitconfig
        - .gitignore_global
        - .gitattributes
