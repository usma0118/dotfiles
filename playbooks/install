#!/bin/bash
set -e
set -u

# shellcheck disable=SC1091
source "$DOTFILES_DIR/lib/log.sh"
# shellcheck disable=SC1091
source "$DOTFILES_DIR/lib/utils.sh"
declare -r DOTFILES_DIR="${DOTFILES_DIR:-}"
declare -r os_family_override="${OS_FAMILY_OVERRIDE:-}"
declare -r playbook_file="${os_family_override:-${os_family}}.yml"
declare -r REMOTE_USER="${REMOTE_USER:-}"
declare -r VIRTUAL_ENV="${VIRTUAL_ENV:-}"
if [ -n "${VIRTUAL_ENV:-}" ]; then
  log_warning 'Ansible in venv: %s\n' "$VIRTUAL_ENV"
elif [ -f "$HOME/.venv/bin/activate" ]; then
  # shellcheck disable=SC1090
  # shellcheck disable=SC1091
  source "$HOME/.venv/bin/activate"
  printf 'info: activated venv at %s/.venv\n' "$HOME"
fi

# Ansible issue with install location
export ANSIBLE_PYTHON_INTERPRETER="$VIRTUAL_ENV/bin/python"
declare -r ANSIBLE_ROLES_PATH="${DOTFILES_DIR}/ansible/roles:${ANSIBLE_ROLES_PATH:-}"
export ANSIBLE_ROLES_PATH

declare -r ANSIBLE_CONFIG="${ANSIBLE_CONFIG:-${DOTFILES_DIR}/ansible.cfg}"
export ANSIBLE_CONFIG

if [[ -n "$os_family_override" ]]; then
  log_info "Using OS family: $os_family with override"
  ansible-playbook -l mac -K "$playbook_file" -b "$@"
elif ! tty -s; then
  log_info "Script is running in unattended mode."
  export ANSIBLE_STDOUT_CALLBACK=minimal
  export ANSIBLE_NO_WARNINGS=True
  ansible-playbook "$playbook_file" -l localhost -u "${SUDO_USER:-$USER}" -b "$@"
else
  log_info "Script is running in attended mode."
  ansible-playbook "$playbook_file" -l container -u "$REMOTE_USER" -b -K "$@"
fi
